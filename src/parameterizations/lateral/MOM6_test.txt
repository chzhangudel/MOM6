1. Parameter fetching.
Each module defines control structure, containing the following information:
- Parameterizations state (if exist, see MOM_MEKE_types.F90)
- All parameters
- is turn on or turn off
- flag "initialized"
- pointer to type(diag_ctrl)
- Diagnostic handles, like "integer :: id_MEKE = -1"

This control structure is allocated in 
MOM.F90, see type(MEKE_CS) and type(thickness_diffuse_CS)

Parameters are defined in _init subroutine. 
- It reads whether parameterisation works and stores it in control structure,
see CS%thickness_diffuse in MOM_thickness_diffuse.F90
- if CS%thickness_diffuse == False, subroutine returns
- Reads all needed parameters with get_param. Parameter need not to be declared elsewhere.

Init function is USUALLY (except of hor_visc_init) called in MOM.F90:
see MEKE_init, thickness_diffuse_init

Fields are offered for output with function register_diag_field
Fields are sended to output with  call post_data(CS%id_Ue, tmp, CS%diag). 
This function requires id_Ue and diag in control structure
Diagnostic fields are 3D stack variables. They are collected in 3D loop.

2. Diagnostics
Dimensions are seend in netcdf files
Kinetic energy definition [In Joules]:
KE_tot = factor1 * 0.5 * dx*dy*h * (u^2 + v^2)
Total mass [in kg]:
mass = factor2 * dx*dy*h
Kinetic energy [in m^2/s2]:
KE_tot / mass, i.e.
int(0.5 * (u^2 + v^2) * h, dxdy) / int(h, dxdy)
Kinetic energy rate of change [in m^3/s^3]:
h * (u*diffu + v*diffv)
Kinetic energy rate of change (total, in m^2/s^3):
int((u*diffu + v*diffv)*h, dxdy) / int(h, dxdy)

3. Tests

[pp2681@gr053 .testing]$ make -j test.grid
PASS: Diagnostics tc2.a.grid.diag agree.
PASS: Solutions tc2.a.grid agree.
PASS: Solutions tc2.grid agree.
PASS: Diagnostics tc2.grid.diag agree.
PASS: Diagnostics tc0.grid.diag agree.
PASS: Solutions tc0.grid agree.
PASS: Diagnostics tc1.a.grid.diag agree.
PASS: Solutions tc1.a.grid agree.
PASS: Diagnostics tc4.grid.diag agree.
PASS: Solutions tc4.grid agree.
PASS: Diagnostics tc1.b.grid.diag agree.
PASS: Solutions tc1.b.grid agree.
PASS: Diagnostics tc1.grid.diag agree.
PASS: Solutions tc1.grid agree.

[pp2681@gr053 .testing]$ make -j test.layout
PASS: Diagnostics tc3.layout.diag agree.
PASS: Solutions tc3.layout agree.
PASS: Diagnostics tc2.a.layout.diag agree.
PASS: Diagnostics tc2.layout.diag agree.
PASS: Diagnostics tc0.layout.diag agree.
PASS: Solutions tc0.layout agree.
PASS: Diagnostics tc1.a.layout.diag agree.
PASS: Solutions tc2.a.layout agree.
PASS: Solutions tc1.a.layout agree.
PASS: Diagnostics tc1.layout.diag agree.
PASS: Solutions tc1.layout agree.
PASS: Solutions tc2.layout agree.
PASS: Diagnostics tc4.layout.diag agree.
PASS: Solutions tc4.layout agree.
PASS: Diagnostics tc1.b.layout.diag agree.
PASS: Solutions tc1.b.layout agree.

[pp2681@gr053 .testing]$ make -j test.restart
PASS: Solutions tc3.restart agree.
PASS: Solutions tc2.a.restart agree.
PASS: Solutions tc2.restart agree.
PASS: Solutions tc1.a.restart agree.
PASS: Solutions tc0.restart agree.
PASS: Solutions tc1.restart agree.
PASS: Solutions tc4.restart agree.
PASS: Solutions tc1.b.restart agree.

[pp2681@gr053 .testing]$ make -j test.nan
PASS: Diagnostics tc3.nan.diag agree.
PASS: Solutions tc3.nan agree.
PASS: Diagnostics tc2.a.nan.diag agree.
PASS: Solutions tc2.a.nan agree.
PASS: Solutions tc2.nan agree.
PASS: Diagnostics tc0.nan.diag agree.
PASS: Diagnostics tc2.nan.diag agree.
PASS: Solutions tc0.nan agree.
PASS: Diagnostics tc1.a.nan.diag agree.
PASS: Solutions tc1.a.nan agree.
PASS: Diagnostics tc1.nan.diag agree.
PASS: Solutions tc1.nan agree.
PASS: Diagnostics tc4.nan.diag agree.
PASS: Solutions tc4.nan agree.
PASS: Diagnostics tc1.b.nan.diag agree.
PASS: Solutions tc1.b.nan agree.

[pp2681@gr053 .testing]$ make -j test.openmp
PASS: Diagnostics tc3.openmp.diag agree.
PASS: Solutions tc3.openmp agree.
PASS: Diagnostics tc2.a.openmp.diag agree.
PASS: Solutions tc2.a.openmp agree.
PASS: Diagnostics tc2.openmp.diag agree.
PASS: Solutions tc2.openmp agree.
PASS: Diagnostics tc0.openmp.diag agree.
PASS: Solutions tc0.openmp agree.
PASS: Diagnostics tc1.a.openmp.diag agree.
PASS: Solutions tc1.a.openmp agree.
PASS: Diagnostics tc1.openmp.diag agree.
PASS: Solutions tc1.openmp agree.
PASS: Diagnostics tc4.openmp.diag agree.
PASS: Solutions tc4.openmp agree.
PASS: Diagnostics tc1.b.openmp.diag agree.
PASS: Solutions tc1.b.openmp agree.

[pp2681@gr053 .testing]$ make -j test.dim
PASS: Solutions tc3.dim.t agree.
PASS: Diagnostics tc3.dim.t.diag agree.
PASS: Solutions tc2.a.dim.t agree.
PASS: Diagnostics tc2.a.dim.t.diag agree.
PASS: Solutions tc2.dim.t agree.
PASS: Diagnostics tc2.dim.t.diag agree.
PASS: Solutions tc0.dim.t agree.
PASS: Diagnostics tc0.dim.t.diag agree.
PASS: Solutions tc1.a.dim.t agree.
PASS: Diagnostics tc1.a.dim.t.diag agree.
PASS: Solutions tc1.dim.t agree.
PASS: Diagnostics tc1.dim.t.diag agree.
PASS: Solutions tc4.dim.t agree.
PASS: Diagnostics tc4.dim.t.diag agree.
PASS: Solutions tc1.b.dim.t agree.
PASS: Diagnostics tc1.b.dim.t.diag agree.
PASS: Solutions tc3.dim.l agree.
PASS: Diagnostics tc3.dim.l.diag agree.
PASS: Solutions tc2.a.dim.l agree.
PASS: Diagnostics tc2.a.dim.l.diag agree.
PASS: Solutions tc2.dim.l agree.
PASS: Diagnostics tc2.dim.l.diag agree.
PASS: Solutions tc0.dim.l agree.
PASS: Diagnostics tc0.dim.l.diag agree.
PASS: Solutions tc1.a.dim.l agree.
PASS: Diagnostics tc1.a.dim.l.diag agree.
PASS: Solutions tc1.dim.l agree.
PASS: Diagnostics tc1.dim.l.diag agree.
PASS: Solutions tc4.dim.l agree.
PASS: Diagnostics tc4.dim.l.diag agree.
PASS: Solutions tc1.b.dim.l agree.
PASS: Diagnostics tc1.b.dim.l.diag agree.
PASS: Solutions tc3.dim.h agree.
PASS: Diagnostics tc3.dim.h.diag agree.
PASS: Solutions tc2.a.dim.h agree.
PASS: Diagnostics tc2.a.dim.h.diag agree.
PASS: Solutions tc2.dim.h agree.
PASS: Diagnostics tc2.dim.h.diag agree.
PASS: Solutions tc0.dim.h agree.
PASS: Diagnostics tc0.dim.h.diag agree.
PASS: Solutions tc1.a.dim.h agree.
PASS: Diagnostics tc1.a.dim.h.diag agree.
PASS: Solutions tc1.dim.h agree.
PASS: Diagnostics tc1.dim.h.diag agree.
PASS: Solutions tc4.dim.h agree.
PASS: Diagnostics tc4.dim.h.diag agree.
PASS: Solutions tc1.b.dim.h agree.
PASS: Diagnostics tc1.b.dim.h.diag agree.
PASS: Solutions tc3.dim.z agree.
PASS: Diagnostics tc3.dim.z.diag agree.
PASS: Solutions tc2.a.dim.z agree.
PASS: Diagnostics tc2.a.dim.z.diag agree.
PASS: Solutions tc2.dim.z agree.
PASS: Diagnostics tc2.dim.z.diag agree.
PASS: Solutions tc0.dim.z agree.
PASS: Diagnostics tc0.dim.z.diag agree.
PASS: Solutions tc1.a.dim.z agree.
PASS: Diagnostics tc1.a.dim.z.diag agree.
PASS: Solutions tc1.dim.z agree.
PASS: Diagnostics tc1.dim.z.diag agree.
PASS: Solutions tc4.dim.z agree.
PASS: Diagnostics tc4.dim.z.diag agree.
PASS: Solutions tc1.b.dim.z agree.
PASS: Diagnostics tc1.b.dim.z.diag agree.
PASS: Solutions tc3.dim.q agree.
PASS: Diagnostics tc3.dim.q.diag agree.
PASS: Solutions tc2.a.dim.q agree.
PASS: Diagnostics tc2.a.dim.q.diag agree.
PASS: Solutions tc2.dim.q agree.
PASS: Diagnostics tc2.dim.q.diag agree.
PASS: Solutions tc0.dim.q agree.
PASS: Diagnostics tc0.dim.q.diag agree.
PASS: Solutions tc1.a.dim.q agree.
PASS: Diagnostics tc1.a.dim.q.diag agree.
PASS: Solutions tc1.dim.q agree.
PASS: Diagnostics tc1.dim.q.diag agree.
PASS: Solutions tc4.dim.q agree.
PASS: Diagnostics tc4.dim.q.diag agree.
PASS: Solutions tc1.b.dim.q agree.
PASS: Diagnostics tc1.b.dim.q.diag agree.
PASS: Solutions tc3.dim.r agree.
PASS: Diagnostics tc3.dim.r.diag agree.
PASS: Solutions tc2.a.dim.r agree.
PASS: Diagnostics tc2.a.dim.r.diag agree.
PASS: Solutions tc2.dim.r agree.
PASS: Diagnostics tc2.dim.r.diag agree.
PASS: Solutions tc0.dim.r agree.
PASS: Diagnostics tc0.dim.r.diag agree.
PASS: Solutions tc1.a.dim.r agree.
PASS: Diagnostics tc1.a.dim.r.diag agree.
PASS: Solutions tc1.dim.r agree.
PASS: Diagnostics tc1.dim.r.diag agree.
PASS: Solutions tc4.dim.r agree.
PASS: Diagnostics tc4.dim.r.diag agree.
PASS: Solutions tc1.b.dim.r agree.
PASS: Diagnostics tc1.b.dim.r.diag agree.